<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard partners | Client Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Ionicons -->
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <link rel="stylesheet" href="./src/theme-intra.css">
    <link rel="stylesheet" href="./src/style.css">
    <!-- Flatpickr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" type="text/css" href="https://npmcdn.com/flatpickr/dist/themes/dark.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

    <!-- ===== LOADING SCREEN ===== -->
    <style>
        #dashboard-loader {
            position: fixed; inset: 0; z-index: 9999;
            background: #000;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            transition: opacity 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #dashboard-loader::before {
            content: '';
            position: absolute; inset: 0;
            background: radial-gradient(ellipse 700px 500px at 50% 45%,
                rgba(160, 0, 90, 0.07) 0%, transparent 70%);
            pointer-events: none;
        }
        #dashboard-loader.fade-out { opacity: 0; pointer-events: none; }

        .ld-inner {
            display: flex; flex-direction: column;
            align-items: center; gap: 24px;
        }
        .ld-logo-wrap {
            position: relative;
            width: 100px; height: 100px;
            display: flex; align-items: center; justify-content: center;
        }
        /* Anillo exterior lento */
        .ld-ring-outer {
            position: absolute; inset: -10px;
            border-radius: 50%;
            border: 1px solid transparent;
            border-left-color: rgba(160, 0, 90, 0.35);
            border-bottom-color: rgba(160, 0, 90, 0.12);
            animation: ld-rev 3.2s linear infinite;
        }
        /* Anillo interior rápido */
        .ld-ring-inner {
            position: absolute; inset: 0;
            border-radius: 50%;
            border: 1.5px solid rgba(255, 255, 255, 0.05);
            border-top-color: rgba(180, 0, 105, 0.95);
            border-right-color: rgba(180, 0, 105, 0.35);
            animation: ld-spin 1.1s cubic-bezier(0.4, 0, 0.2, 1) infinite;
        }
        @keyframes ld-spin { to { transform: rotate(360deg); } }
        @keyframes ld-rev  { to { transform: rotate(-360deg); } }

        .ld-logo {
            width: 42px; height: auto; opacity: 0.9;
            animation: ld-breathe 3s ease-in-out infinite;
        }
        @keyframes ld-breathe {
            0%, 100% { opacity: 0.9; transform: scale(1); }
            50%       { opacity: 0.55; transform: scale(0.91); }
        }
        .ld-label {
            font-family: 'Inter', sans-serif;
            font-size: 0.7rem; font-weight: 500;
            color: rgba(255, 255, 255, 0.22);
            letter-spacing: 0.16em; text-transform: uppercase;
        }
        .ld-dots {
            display: flex; gap: 7px; align-items: center;
        }
        .ld-dots span {
            width: 4px; height: 4px; border-radius: 50%;
            background: rgba(180, 0, 105, 0.8);
            animation: ld-dot 1.4s ease-in-out infinite;
        }
        .ld-dots span:nth-child(2) { animation-delay: 0.22s; }
        .ld-dots span:nth-child(3) { animation-delay: 0.44s; }
        @keyframes ld-dot {
            0%, 80%, 100% { transform: scale(0.5); opacity: 0.25; }
            40%            { transform: scale(1);   opacity: 1; }
        }
        /* Barra de progreso inferior */
        .ld-bar-track {
            position: absolute; bottom: 0; left: 0; right: 0;
            height: 2px; background: rgba(255, 255, 255, 0.04);
        }
        .ld-bar-fill {
            height: 100%; width: 0%;
            background: linear-gradient(90deg,
                rgba(160, 0, 90, 0.6) 0%,
                rgba(190, 0, 115, 1) 80%);
            box-shadow: 0 0 18px rgba(180, 0, 105, 0.5),
                        0 0  5px rgba(180, 0, 105, 0.85);
            transition: width 0.75s cubic-bezier(0.4, 0, 0.2, 1);
        }
    </style>

    <div id="dashboard-loader">
        <div class="ld-inner">
            <div class="ld-logo-wrap">
                <div class="ld-ring-outer"></div>
                <div class="ld-ring-inner"></div>
                <img src="src/assets/intra-logo.png" class="ld-logo" alt="Intra">
            </div>
            <span class="ld-label">Casi listo</span>
            <div class="ld-dots"><span></span><span></span><span></span></div>
        </div>
        <div class="ld-bar-track">
            <div class="ld-bar-fill" id="loader-bar"></div>
        </div>
    </div>
    <!-- ===== FIN LOADING SCREEN ===== -->

    <div class="app-container full-width-layout" id="app-wrapper">
        <!-- Main Header -->
        <header class="main-header">
            <div class="header-left">
                <div class="client-branding">
                    <img id="client-logo" src="" alt="Client Logo" class="client-logo-img hidden">
                    <div class="welcome-area">
                        <span class="welcome-label">Bienvenido,</span>
                        <h2 class="welcome-name" id="welcome-name">Administrador</h2>
                    </div>
                </div>
            </div>

            <div class="header-right">
                <div class="intra-branding">
                    <img src="src/assets/intra-logo.png" alt="Intra" class="intra-logo-img">
                    <span class="partner-tag">Partner Portal</span>
                </div>
                <button id="ventas-toggle-btn" onclick="toggleVentas()" class="logout-btn" title="Registrar ventas" style="background: rgba(1,241,227,0.08); border-color: rgba(1,241,227,0.18); color: rgba(1,241,227,0.8);">
                    <ion-icon name="cash-outline"></ion-icon>
                </button>
                <button onclick="logout()" class="logout-btn" title="Cerrar sesión">
                    <ion-icon name="log-out-outline"></ion-icon>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <div class="content-header-row">
                <div class="header-title-area">
                    <div class="live-label">
                        <div class="live-dot"></div>
                        <span>Última actualización: Ahora mismo</span>
                    </div>
                    <h1 class="section-headline">
                        Dashboard <ion-icon name="globe-outline" class="globe-icon"></ion-icon>
                    </h1>
                </div>

                <!-- Global Range Selector -->
                <div class="global-range-selector">
                    <div class="range-display" id="range-picker-toggle">
                        <ion-icon name="calendar-outline"></ion-icon>
                        <span id="current-range-label">Todo el tiempo</span>
                        <ion-icon name="chevron-down-outline" class="chevron"></ion-icon>
                    </div>

                    <div class="range-dropdown hidden" id="range-dropdown">
                        <div class="custom-range-inputs">
                            <span class="label">Seleccionar rango personalizado:</span>
                            <div class="inputs-row">
                                <input type="text" id="date-range-picker" class="range-input-field full-width"
                                    placeholder="Clic para abrir calendario..." readonly>
                            </div>
                        </div>
                        <div class="dropdown-divider"></div>
                        <button class="range-opt" data-range="today">Hoy</button>
                        <button class="range-opt" data-range="7d">Últimos 7 días</button>
                        <button class="range-opt" data-range="30d">Últimos 30 días</button>
                        <button class="range-opt" data-range="this-month">Este mes</button>
                        <button class="range-opt" data-range="last-month">Mes pasado</button>
                        <button class="range-opt" data-range="all">Todo el tiempo</button>
                    </div>
                </div>
            </div>

            <!-- Hotel Tabs (visible solo para clientes tipo hotel) -->
            <div id="hotel-tabs" class="dashboard-tabs hidden">
                <div class="dash-tabs-segment">
                    <button class="dash-tab active" data-tab="reservas">
                        <ion-icon name="bed-outline"></ion-icon> Reservas
                    </button>
                    <button class="dash-tab" data-tab="daypass">
                        <ion-icon name="sunny-outline"></ion-icon> DayPass
                    </button>
                    <button class="dash-tab" data-tab="eventos">
                        <ion-icon name="calendar-outline"></ion-icon> Eventos
                    </button>
                </div>
            </div>

            <!-- Dashboard Grid -->
            <div class="dashboard-grid">

                <!-- Cards Row -->
                <div class="cards-grid">
                    <!-- Card 1: Leads Calificados -->
                    <div class="card-quantix card-orange">
                        <div class="card-accent-line orange"></div>
                        <div class="card-header">
                            <div class="card-title-wrapper">
                                <div class="icon-box"
                                    style="background: rgba(245, 158, 11, 0.1); border-color: rgba(245, 158, 11, 0.3); color: #F59E0B;">
                                    <ion-icon name="ribbon"></ion-icon>
                                </div>
                                <div class="label-group">
                                    <span class="label-sub">CALIDAD</span>
                                    <span class="label-main">Oportunidades calificadas</span>
                                </div>
                            </div>
                        </div>

                        <div class="value-big" id="card-1-value">0</div>
                        <div class="pill-change pill-green">
                            <ion-icon name="arrow-up"></ion-icon> High Quality
                        </div>

                        <div class="card-chart-container">
                            <canvas id="chart-1"></canvas>
                        </div>
                    </div>

                    <!-- Card 2: Tasa de Conversión -->
                    <div class="card-quantix card-purple">
                        <div class="card-accent-line purple"></div>
                        <div class="card-header">
                            <div class="card-title-wrapper">
                                <div class="icon-box"
                                    style="background: rgba(117, 81, 255, 0.1); border-color: rgba(117, 81, 255, 0.3); color: #7551FF;">
                                    <ion-icon name="swap-vertical"></ion-icon>
                                </div>
                                <div class="label-group">
                                    <span class="label-sub">Oportunidades calificadas / Leads</span>
                                    <span class="label-main">Tasa de Conversión</span>
                                </div>
                            </div>
                        </div>

                        <div class="value-big" id="card-2-value">0.0</div>
                        <div class="pill-change pill-green"
                            style="background: rgba(117, 81, 255, 0.15); color: #7551FF;">
                            Ratio Actual
                        </div>

                        <div class="card-chart-container">
                            <canvas id="chart-2"></canvas>
                        </div>
                    </div>

                    <!-- Card 3: Ventas -->
                    <div class="card-quantix card-cyan">
                        <div class="card-accent-line cyan"></div>
                        <div class="card-header">
                            <div class="card-title-wrapper">
                                <div class="icon-box"
                                    style="background: rgba(1, 241, 227, 0.1); border-color: rgba(1, 241, 227, 0.3); color: #01F1E3;">
                                    <ion-icon name="cash"></ion-icon>
                                </div>
                                <div class="label-group">
                                    <span class="label-sub">INGRESOS TOTALES</span>
                                    <span class="label-main">Ventas</span>
                                </div>
                            </div>
                        </div>

                        <div class="value-big" id="card-3-value">$0</div>
                        <div class="pill-change" style="visibility: hidden;">Spacer</div>

                        <div class="card-chart-container">
                            <canvas id="chart-3"></canvas>
                        </div>
                    </div>

                    <!-- Card 4: ROI -->
                    <div class="card-quantix card-pink">
                        <div class="card-accent-line pink"></div>
                        <div class="card-header">
                            <div class="card-title-wrapper">
                                <div class="icon-box"
                                    style="background: rgba(255, 0, 229, 0.1); border-color: rgba(255, 0, 229, 0.3); color: #FF00E5;">
                                    <ion-icon name="rocket"></ion-icon>
                                </div>
                                <div class="label-group">
                                    <span class="label-sub">VENTAS / INVERSIÓN</span>
                                    <span class="label-main">ROI</span>
                                </div>
                            </div>
                        </div>

                        <div class="value-big" id="card-4-value">0.0x</div>
                        <div class="pill-change" style="visibility: hidden;">Spacer</div>

                        <div class="card-chart-container">
                            <canvas id="chart-4"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Middle Row: Chart & Table (50/50) -->
                <div class="split-row-grid">
                    <!-- Main Big Chart -->
                    <div class="card-quantix big-chart-card">
                        <div class="card-header" style="margin-bottom: 20px;">
                            <div>
                                <span class="label-sub">TENDENCIA HISTÓRICA</span>
                                <h3 class="section-headline" style="font-size: 1.5rem; margin: 0;">Comportamiento</h3>
                            </div>
                        </div>
                        <div style="flex: 1; position: relative; width: 100%;">
                            <canvas id="main-chart"></canvas>
                        </div>
                    </div>

                    <!-- Table Card -->
                    <div class="table-card" style="display: flex; flex-direction: column;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h3 style="margin: 0; font-size: 1.1rem; color: var(--text-secondary);">Últimos leads
                                calificados
                            </h3>
                            <button id="view-all-btn" class="header-icon-btn" title="Ver info completa">
                                <ion-icon name="open-outline"></ion-icon>
                            </button>
                        </div>
                        <div class="table-wrapper" style="border:none; padding:0; background:none;">
                            <table>
                                <thead>
                                    <tr>
                                        <th style="width: 40px;">#</th>
                                        <th>Nombre</th>
                                        <th>Fecha</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody id="leads-table-body">
                                    <!-- JS Injection -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Bottom Row: Remaining Cards -->
                <div class="bottom-cards-row">
                    <!-- Card 5: Total Leads -->
                    <div class="card-quantix card-orange">
                        <div class="card-accent-line orange"></div>
                        <div class="card-header">
                            <div class="card-title-wrapper">
                                <div class="icon-box"
                                    style="background: rgba(245, 158, 11, 0.1); border-color: rgba(245, 158, 11, 0.3); color: #F59E0B;">
                                    <ion-icon name="people"></ion-icon>
                                </div>
                                <div class="label-group">
                                    <span class="label-sub">Personas que mandaron mensaje</span>
                                    <span class="label-main">Total de Registros</span>
                                </div>
                            </div>
                        </div>
                        <div class="value-big" id="card-5-value">0</div>
                        <div class="pill-change pill-green">Generados</div>
                        <div class="card-chart-container"><canvas id="chart-5"></canvas></div>
                    </div>

                    <!-- Card 6: Inversión -->
                    <div class="card-quantix card-pink">
                        <div class="card-accent-line pink"></div>
                        <div class="card-header">
                            <div class="card-title-wrapper">
                                <div class="icon-box"
                                    style="background: rgba(255, 0, 229, 0.1); border-color: rgba(255, 0, 229, 0.3); color: #FF00E5;">
                                    <ion-icon name="wallet"></ion-icon>
                                </div>
                                <div class="label-group">
                                    <span class="label-sub"></span>
                                    <span class="label-main">Inversión</span>
                                </div>
                            </div>
                        </div>
                        <div class="value-big" id="card-6-value">$0</div>
                        <div class="pill-change pill-red" id="card-6-date">Presupuesto</div>
                        <div class="card-chart-container"><canvas id="chart-6"></canvas></div>
                    </div>

                    <!-- Card 7: CPL -->
                    <div class="card-quantix card-cyan">
                        <div class="card-accent-line cyan"></div>
                        <div class="card-header">
                            <div class="card-title-wrapper">
                                <div class="icon-box"
                                    style="background: rgba(1, 241, 227, 0.1); border-color: rgba(1, 241, 227, 0.3); color: #01F1E3;">
                                    <ion-icon name="pricetag"></ion-icon>
                                </div>
                                <div class="label-group">
                                    <span class="label-sub"></span>
                                    <span class="label-main">Costo por oportunidad calificada</span>
                                </div>
                            </div>
                        </div>
                        <div class="value-big" id="card-7-value">$0.00</div>
                        <div class="pill-change pill-green">Eficiencia</div>
                        <div class="card-chart-container"><canvas id="chart-7"></canvas></div>
                    </div>
                </div>


                <!-- Modal Structure -->
                <div id="leads-modal" class="modal-overlay hidden">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Detalle Completo de Leads</h3>
                            <button class="close-modal">&times;</button>
                        </div>
                        <div class="modal-body">
                            <table class="modal-table">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Nombre</th>
                                        <th>Fecha</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody id="modal-table-body">
                                    <!-- JS Injection -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
        </main>

        <footer style="text-align: center; padding: 16px; color: var(--text-dim); font-size: 0.8rem; opacity: 0.5;">
            &copy; 2026 Intra. Todos los derechos reservados.
        </footer>
    </div><!-- /#app-wrapper -->

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="src/config.js"></script>
    <script src="src/auth.js"></script>
    <script src="src/dashboard.js"></script>

    <!-- Client Switcher Drawer -->
    <style>
        /* === TOGGLE BUTTON === */
        #switcher-toggle-btn {
            position: fixed;
            left: 20px;
            bottom: 24px;
            z-index: 300;
            width: 46px;
            height: 46px;
            border-radius: 14px;
            background: linear-gradient(135deg, rgba(117, 81, 255, 0.18), rgba(1, 241, 227, 0.08));
            border: 1px solid rgba(117, 81, 255, 0.35);
            color: rgba(255, 255, 255, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.15rem;
            backdrop-filter: blur(16px);
            box-shadow: 0 4px 24px rgba(117, 81, 255, 0.25), 0 0 0 1px rgba(117, 81, 255, 0.15);
            transition: all 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        #switcher-toggle-btn:hover {
            background: linear-gradient(135deg, rgba(117, 81, 255, 0.35), rgba(1, 241, 227, 0.15));
            border-color: rgba(117, 81, 255, 0.6);
            color: white;
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 8px 32px rgba(117, 81, 255, 0.4), 0 0 0 1px rgba(117, 81, 255, 0.3);
        }

        /* === OVERLAY BACKDROP === */
        #switcher-backdrop {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 250;
            backdrop-filter: blur(4px);
            animation: fadeInBackdrop 0.2s ease;
        }

        @keyframes fadeInBackdrop {
            from { opacity: 0; }
            to   { opacity: 1; }
        }

        #switcher-backdrop.open {
            display: block;
        }

        /* === DRAWER === */
        #client-switcher-drawer {
            position: fixed;
            left: -280px;
            top: 0;
            bottom: 0;
            width: 260px;
            background: linear-gradient(180deg, #0c0d16 0%, #080910 100%);
            border-right: 1px solid rgba(117, 81, 255, 0.15);
            z-index: 260;
            display: flex;
            flex-direction: column;
            transition: left 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(24px);
            box-shadow: 6px 0 40px rgba(0, 0, 0, 0.7), 1px 0 0 rgba(117, 81, 255, 0.1);
        }

        /* Accent glow line on the right edge */
        #client-switcher-drawer::after {
            content: '';
            position: absolute;
            top: 10%;
            right: -1px;
            width: 2px;
            height: 80%;
            background: linear-gradient(180deg, transparent, rgba(117, 81, 255, 0.5), rgba(1, 241, 227, 0.3), transparent);
            border-radius: 2px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        #client-switcher-drawer.open::after {
            opacity: 1;
        }

        #client-switcher-drawer.open {
            left: 0;
        }

        /* === HEADER === */
        .drawer-header {
            padding: 22px 20px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .drawer-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(117, 81, 255, 0.6), rgba(1, 241, 227, 0.3), transparent);
        }

        .drawer-header span {
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            background: linear-gradient(90deg, #7551FF, #01F1E3);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-family: 'Inter', sans-serif;
        }

        .drawer-close-btn {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.08);
            color: rgba(255, 255, 255, 0.45);
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .drawer-close-btn:hover {
            color: white;
            background: rgba(255, 77, 77, 0.12);
            border-color: rgba(255, 77, 77, 0.25);
        }

        /* === CLIENT LIST === */
        .drawer-clients-list {
            flex: 1;
            overflow-y: auto;
            padding: 14px 12px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            scrollbar-width: thin;
            scrollbar-color: rgba(117, 81, 255, 0.3) transparent;
        }

        .drawer-clients-list::-webkit-scrollbar {
            width: 3px;
        }

        .drawer-clients-list::-webkit-scrollbar-thumb {
            background: rgba(117, 81, 255, 0.3);
            border-radius: 4px;
        }

        .drawer-client-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 11px 13px;
            border-radius: 14px;
            cursor: pointer;
            text-decoration: none;
            color: rgba(255, 255, 255, 0.6);
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.04);
            transition: all 0.22s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-family: 'Inter', sans-serif;
            position: relative;
            overflow: hidden;
        }

        .drawer-client-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(180deg, #7551FF, #01F1E3);
            border-radius: 0 2px 2px 0;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .drawer-client-item:hover {
            background: rgba(117, 81, 255, 0.07);
            color: white;
            border-color: rgba(117, 81, 255, 0.2);
            transform: translateX(3px);
        }

        .drawer-client-item:hover::before {
            opacity: 0.6;
        }

        .drawer-client-item.active {
            background: linear-gradient(135deg, rgba(117, 81, 255, 0.14), rgba(1, 241, 227, 0.05));
            border-color: rgba(117, 81, 255, 0.4);
            color: white;
            box-shadow: 0 4px 20px rgba(117, 81, 255, 0.15), inset 0 1px 0 rgba(255,255,255,0.05);
        }

        .drawer-client-item.active::before {
            opacity: 1;
        }

        /* === LOGO BOX === */
        .drawer-client-logo {
            width: 38px;
            height: 38px;
            border-radius: 11px;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.09);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .drawer-client-item.active .drawer-client-logo {
            border-color: rgba(117, 81, 255, 0.4);
            box-shadow: 0 0 12px rgba(117, 81, 255, 0.2);
        }

        .drawer-client-logo img {
            width: 30px;
            height: 30px;
            object-fit: contain;
        }

        .drawer-client-logo .initials {
            font-size: 1rem;
            font-weight: 700;
            background: linear-gradient(135deg, #7551FF, #01F1E3);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* === CLIENT NAME === */
        .drawer-client-name {
            font-size: 0.83rem;
            font-weight: 500;
            line-height: 1.25;
            letter-spacing: 0.01em;
        }

        /* === FOOTER === */
        .drawer-footer {
            padding: 12px 12px 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .drawer-hub-link {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 11px 14px;
            border-radius: 12px;
            color: rgba(255, 255, 255, 0.35);
            text-decoration: none;
            font-size: 0.8rem;
            font-weight: 500;
            font-family: 'Inter', sans-serif;
            border: 1px solid transparent;
            transition: all 0.2s;
        }

        .drawer-hub-link:hover {
            background: rgba(117, 81, 255, 0.08);
            border-color: rgba(117, 81, 255, 0.2);
            color: rgba(255, 255, 255, 0.7);
        }

        .drawer-hub-link ion-icon {
            font-size: 1rem;
            color: rgba(117, 81, 255, 0.6);
        }

        /* Ocultar botón cuando el drawer está abierto */
        #client-switcher-drawer.open ~ #switcher-toggle-btn {
            opacity: 0;
            pointer-events: none;
            transform: scale(0.85);
        }

        @media (max-width: 768px) {
            #switcher-toggle-btn {
                display: none !important;
            }
        }
    </style>

    <!-- Drawer HTML (injected here, not inside app-wrapper) -->
    <div id="switcher-backdrop" onclick="closeSwitcher()"></div>
    <div id="client-switcher-drawer">
        <div class="drawer-header">
            <span>Mis Dashboards</span>
            <button class="drawer-close-btn" onclick="closeSwitcher()">
                <ion-icon name="close-outline"></ion-icon>
            </button>
        </div>
        <div id="drawer-clients-list" class="drawer-clients-list">
            <!-- JS Generated -->
        </div>
        <div class="drawer-footer">
            <a href="hub.html" class="drawer-hub-link">
                <ion-icon name="grid-outline"></ion-icon>
                Ver todos los dashboards
                <ion-icon name="arrow-forward-outline" style="margin-left:auto; font-size:0.85rem; opacity:0.5;"></ion-icon>
            </a>
        </div>
    </div>

    <button id="switcher-toggle-btn" onclick="toggleSwitcher()" title="Cambiar dashboard">
        <ion-icon name="apps-outline"></ion-icon>
    </button>

    <!-- ===== PANEL DE VENTAS ===== -->
    <style>
        #ventas-backdrop {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            z-index: 1100;
            opacity: 0; pointer-events: none;
            transition: opacity 0.25s ease;
        }
        #ventas-backdrop.open { opacity: 1; pointer-events: all; }

        #ventas-panel {
            position: fixed;
            top: 0; right: -420px;
            width: 400px;
            height: 100vh;
            background: #111114;
            border-left: 1px solid rgba(255,255,255,0.07);
            z-index: 1101;
            display: flex;
            flex-direction: column;
            transition: right 0.3s cubic-bezier(0.4,0,0.2,1);
            font-family: 'Inter', sans-serif;
        }
        #ventas-panel.open { right: 0; }

        .vp-header {
            padding: 20px 20px 16px;
            border-bottom: 1px solid rgba(255,255,255,0.07);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }
        .vp-title {
            display: flex; align-items: center; gap: 10px;
            font-size: 1rem; font-weight: 600; color: #fff;
        }
        .vp-title ion-icon { color: #01F1E3; font-size: 1.1rem; }
        .vp-close {
            width: 30px; height: 30px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 8px; color: rgba(255,255,255,0.4);
            cursor: pointer; display: flex;
            align-items: center; justify-content: center;
            font-size: 1.1rem; transition: all 0.15s;
        }
        .vp-close:hover { background: rgba(255,69,58,0.12); color: #FF453A; }

        /* Formulario */
        .vp-form {
            padding: 16px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.06);
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex-shrink: 0;
            background: rgba(255,255,255,0.015);
        }
        .vp-form-title {
            font-size: 0.68rem; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.8px;
            color: rgba(255,255,255,0.3);
            margin-bottom: 2px;
        }
        .vp-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .vp-field { display: flex; flex-direction: column; gap: 4px; }
        .vp-label { font-size: 0.72rem; color: rgba(255,255,255,0.4); }
        .vp-input {
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 8px;
            padding: 9px 12px;
            color: #fff;
            font-family: 'Inter', sans-serif;
            font-size: 0.875rem;
            outline: none;
            transition: border-color 0.15s;
        }
        .vp-input:focus { border-color: #01F1E3; }
        .vp-input::placeholder { color: rgba(255,255,255,0.2); }
        .vp-actions { display: flex; gap: 8px; }
        .vp-btn-save {
            flex: 1; padding: 10px;
            background: rgba(1,241,227,0.12);
            border: 1px solid rgba(1,241,227,0.25);
            border-radius: 8px;
            color: #01F1E3;
            font-weight: 600; font-size: 0.82rem;
            cursor: pointer; font-family: 'Inter', sans-serif;
            transition: all 0.15s;
        }
        .vp-btn-save:hover { background: rgba(1,241,227,0.22); }
        .vp-btn-cancel {
            padding: 10px 16px;
            background: transparent;
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 8px;
            color: rgba(255,255,255,0.35);
            font-size: 0.82rem; cursor: pointer;
            font-family: 'Inter', sans-serif;
            transition: all 0.15s; display: none;
        }
        .vp-btn-cancel:hover { color: #FF453A; border-color: rgba(255,69,58,0.2); }

        /* Lista de ventas */
        .vp-list {
            flex: 1; overflow-y: auto;
            padding: 12px 20px;
            scrollbar-width: thin;
            scrollbar-color: rgba(255,255,255,0.1) transparent;
        }
        .vp-list::-webkit-scrollbar { width: 3px; }
        .vp-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }

        .vp-list-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 10px;
        }
        .vp-list-title {
            font-size: 0.68rem; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.8px;
            color: rgba(255,255,255,0.3);
        }
        .vp-total {
            font-size: 0.78rem; font-weight: 600;
            color: #01F1E3;
        }

        .vp-empty {
            display: flex; flex-direction: column;
            align-items: center; gap: 8px;
            padding: 40px 0; color: rgba(255,255,255,0.2);
            font-size: 0.82rem; text-align: center;
        }
        .vp-empty ion-icon { font-size: 2rem; }

        .vp-item {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 10px;
            padding: 12px 14px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: border-color 0.15s;
        }
        .vp-item:hover { border-color: rgba(255,255,255,0.12); }
        .vp-item-info { flex: 1; min-width: 0; }
        .vp-item-monto {
            font-size: 0.95rem; font-weight: 600; color: #fff;
        }
        .vp-item-meta {
            font-size: 0.72rem; color: rgba(255,255,255,0.35);
            margin-top: 2px; white-space: nowrap;
            overflow: hidden; text-overflow: ellipsis;
        }
        .vp-item-autor {
            display: flex; align-items: center; gap: 3px;
            font-size: 0.68rem; color: rgba(1,241,227,0.5);
            margin-top: 3px;
        }
        .vp-item-autor ion-icon { font-size: 0.65rem; }
        .vp-item-btns { display: flex; gap: 6px; flex-shrink: 0; }
        .vp-icon-btn {
            width: 28px; height: 28px;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.07);
            border-radius: 7px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.85rem; color: rgba(255,255,255,0.3);
            transition: all 0.15s;
        }
        .vp-icon-btn:hover { background: rgba(255,255,255,0.08); color: #fff; }
        .vp-icon-btn.delete:hover { background: rgba(255,69,58,0.12); color: #FF453A; border-color: rgba(255,69,58,0.2); }
        .vp-icon-btn.edit:hover { background: rgba(1,241,227,0.1); color: #01F1E3; border-color: rgba(1,241,227,0.2); }

        .vp-loading {
            display: flex; align-items: center; justify-content: center;
            gap: 8px; padding: 30px; color: rgba(255,255,255,0.25);
            font-size: 0.82rem;
        }
    </style>

    <div id="ventas-backdrop" onclick="closeVentas()"></div>

    <div id="ventas-panel">
        <div class="vp-header">
            <div class="vp-title">
                <ion-icon name="cash-outline"></ion-icon>
                Registro de Ventas
            </div>
            <button class="vp-close" onclick="closeVentas()">
                <ion-icon name="close-outline"></ion-icon>
            </button>
        </div>

        <!-- Formulario agregar/editar -->
        <div class="vp-form">
            <div class="vp-form-title" id="vp-form-title">Nueva Venta</div>
            <input type="hidden" id="vp-editing-id">
            <div class="vp-row">
                <div class="vp-field">
                    <label class="vp-label">Monto ($)</label>
                    <input type="number" id="vp-monto" class="vp-input" placeholder="0.00" step="0.01" min="0">
                </div>
                <div class="vp-field">
                    <label class="vp-label">Fecha</label>
                    <input type="date" id="vp-fecha" class="vp-input">
                </div>
            </div>
            <div class="vp-field">
                <label class="vp-label">Descripción (opcional)</label>
                <input type="text" id="vp-descripcion" class="vp-input" placeholder="Ej: Reservación habitación doble">
            </div>
            <div class="vp-actions">
                <button class="vp-btn-save" onclick="saveVenta()">
                    <ion-icon name="checkmark-outline"></ion-icon> Guardar Venta
                </button>
                <button class="vp-btn-cancel" id="vp-cancel-btn" onclick="cancelEditVenta()">
                    Cancelar
                </button>
            </div>
        </div>

        <!-- Lista -->
        <div class="vp-list">
            <div class="vp-list-header">
                <span class="vp-list-title">Ventas registradas</span>
                <span class="vp-total" id="vp-total-label"></span>
            </div>
            <div id="vp-items-container">
                <div class="vp-loading">
                    <ion-icon name="sync-outline"></ion-icon> Cargando...
                </div>
            </div>
        </div>
    </div>

    <!-- ===== LÓGICA DE VENTAS ===== -->
    <script>
        // ── Helpers ──────────────────────────────────────────────
        function getClientSlug() {
            return new URLSearchParams(window.location.search).get('client') || '';
        }

        function formatMoney(n) {
            return '$' + Number(n).toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const [y, m, d] = dateStr.split('-');
            return `${d}/${m}/${y}`;
        }

        function todayISO() {
            return new Date().toISOString().split('T')[0];
        }

        // ── Panel open/close ──────────────────────────────────────
        function toggleVentas() {
            const panel = document.getElementById('ventas-panel');
            if (panel.classList.contains('open')) {
                closeVentas();
            } else {
                openVentas();
            }
        }

        function openVentas() {
            document.getElementById('ventas-panel').classList.add('open');
            document.getElementById('ventas-backdrop').classList.add('open');
            // Asegurar fecha de hoy por defecto
            const fechaInput = document.getElementById('vp-fecha');
            if (!fechaInput.value) fechaInput.value = todayISO();
            loadVentas();
        }

        function closeVentas() {
            document.getElementById('ventas-panel').classList.remove('open');
            document.getElementById('ventas-backdrop').classList.remove('open');
        }

        // ── CRUD ─────────────────────────────────────────────────
        async function loadVentas() {
            const slug = getClientSlug();
            if (!slug) return;

            document.getElementById('vp-items-container').innerHTML =
                '<div class="vp-loading"><ion-icon name="sync-outline"></ion-icon> Cargando...</div>';

            const { data, error } = await supabase
                .from('ventas')
                .select('*')
                .eq('client_slug', slug)
                .order('fecha', { ascending: false });

            renderVentas(error ? [] : (data || []));
        }

        function renderVentas(ventas) {
            const container = document.getElementById('vp-items-container');
            const totalLabel = document.getElementById('vp-total-label');

            if (!ventas.length) {
                container.innerHTML = `
                    <div class="vp-empty">
                        <ion-icon name="receipt-outline"></ion-icon>
                        <span>Aún no hay ventas registradas</span>
                    </div>`;
                totalLabel.textContent = '';
                return;
            }

            const total = ventas.reduce((s, v) => s + parseFloat(v.monto), 0);
            totalLabel.textContent = formatMoney(total);

            container.innerHTML = ventas.map(v => `
                <div class="vp-item" id="vp-item-${v.id}">
                    <div class="vp-item-info">
                        <div class="vp-item-monto">${formatMoney(v.monto)}</div>
                        <div class="vp-item-meta">
                            ${formatDate(v.fecha)}
                            ${v.descripcion ? ' · ' + v.descripcion : ''}
                        </div>
                        ${v.registrado_por ? `<div class="vp-item-autor"><ion-icon name="person-outline"></ion-icon> ${v.registrado_por}</div>` : ''}
                    </div>
                    <div class="vp-item-btns">
                        <button class="vp-icon-btn edit" onclick="editVenta('${v.id}','${v.monto}','${v.fecha}',${JSON.stringify(v.descripcion || '')})" title="Editar">
                            <ion-icon name="pencil-outline"></ion-icon>
                        </button>
                        <button class="vp-icon-btn delete" onclick="deleteVenta('${v.id}')" title="Eliminar">
                            <ion-icon name="trash-outline"></ion-icon>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function saveVenta() {
            const monto = parseFloat(document.getElementById('vp-monto').value);
            const fecha = document.getElementById('vp-fecha').value;
            const descripcion = document.getElementById('vp-descripcion').value.trim();
            const editingId = document.getElementById('vp-editing-id').value;
            const session = typeof getSession === 'function' ? getSession() : null;

            if (!monto || monto <= 0 || !fecha) {
                alert('Por favor ingresa monto y fecha válidos.');
                return;
            }

            const payload = {
                client_slug: getClientSlug(),
                monto,
                fecha,
                descripcion,
                registrado_por: session ? (session.name || session.email || '') : ''
            };

            let error;
            if (editingId) {
                ({ error } = await supabase.from('ventas').update(payload).eq('id', editingId));
            } else {
                ({ error } = await supabase.from('ventas').insert([payload]));
            }

            if (error) {
                alert('Error al guardar: ' + error.message);
                return;
            }

            resetVentaForm();
            loadVentas();
            if (typeof refreshVentasDashboard === 'function') refreshVentasDashboard();
        }

        async function deleteVenta(id) {
            if (!confirm('¿Eliminar esta venta?')) return;
            const { error } = await supabase.from('ventas').delete().eq('id', id);
            if (error) { alert('Error al eliminar: ' + error.message); return; }
            loadVentas();
            if (typeof refreshVentasDashboard === 'function') refreshVentasDashboard();
        }

        function editVenta(id, monto, fecha, descripcion) {
            document.getElementById('vp-editing-id').value = id;
            document.getElementById('vp-monto').value = monto;
            document.getElementById('vp-fecha').value = fecha;
            document.getElementById('vp-descripcion').value = descripcion;
            document.getElementById('vp-form-title').textContent = 'Editar Venta';
            document.getElementById('vp-cancel-btn').style.display = 'block';
            // Scroll al formulario
            document.querySelector('.vp-form').scrollIntoView({ behavior: 'smooth' });
        }

        function cancelEditVenta() {
            resetVentaForm();
        }

        function resetVentaForm() {
            document.getElementById('vp-editing-id').value = '';
            document.getElementById('vp-monto').value = '';
            document.getElementById('vp-fecha').value = todayISO();
            document.getElementById('vp-descripcion').value = '';
            document.getElementById('vp-form-title').textContent = 'Nueva Venta';
            document.getElementById('vp-cancel-btn').style.display = 'none';
        }
    </script>

    <script>
        function toggleSwitcher() {
            document.getElementById('client-switcher-drawer').classList.toggle('open');
            document.getElementById('switcher-backdrop').classList.toggle('open');
        }
        function closeSwitcher() {
            document.getElementById('client-switcher-drawer').classList.remove('open');
            document.getElementById('switcher-backdrop').classList.remove('open');
        }

        (async function initClientSwitcher() {
            const session = typeof getSession === 'function' ? getSession() : null;
            if (!session || !session.clients || session.clients.length <= 1) return;

            const { data: clients } = await supabase
                .from('clients_config')
                .select('id_slug, name, logo_url, theme_primary')
                .in('id_slug', session.clients);

            if (!clients || clients.length <= 1) return;

            const urlParams = new URLSearchParams(window.location.search);
            const currentClient = urlParams.get('client');

            const list = document.getElementById('drawer-clients-list');
            list.innerHTML = clients.map(client => {
                const isActive = client.id_slug === currentClient;
                const logoHtml = client.logo_url
                    ? `<img src="${client.logo_url}" alt="${client.name}">`
                    : `<span class="initials">${client.name.charAt(0)}</span>`;

                return `
                    <a class="drawer-client-item ${isActive ? 'active' : ''}"
                       href="index.html?client=${client.id_slug}"
                       onclick="closeSwitcher()"
                       style="${isActive ? `border-color: ${client.theme_primary || '#7551FF'};` : ''}">
                        <div class="drawer-client-logo">${logoHtml}</div>
                        <span class="drawer-client-name">${client.name}</span>
                    </a>
                `;
            }).join('');

            // Mostrar el botón toggle
            document.getElementById('switcher-toggle-btn').style.display = 'flex';
        })();
    </script>
</body>

</html>